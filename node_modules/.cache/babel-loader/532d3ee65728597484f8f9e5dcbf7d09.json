{"ast":null,"code":"/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * \n */\nimport { isPrimaryRenderer } from './ReactFiberHostConfig'; // Work in progress version numbers only apply to a single render,\n// and should be reset before starting a new render.\n// This tracks which mutable sources need to be reset after a render.\n\nconst workInProgressSources = [];\nlet rendererSigil;\n\nif (__DEV__) {\n  // Used to detect multiple renderers using the same mutable source.\n  rendererSigil = {};\n}\n\nexport function markSourceAsDirty(mutableSource) {\n  workInProgressSources.push(mutableSource);\n}\nexport function resetWorkInProgressVersions() {\n  for (let i = 0; i < workInProgressSources.length; i++) {\n    const mutableSource = workInProgressSources[i];\n\n    if (isPrimaryRenderer) {\n      mutableSource._workInProgressVersionPrimary = null;\n    } else {\n      mutableSource._workInProgressVersionSecondary = null;\n    }\n  }\n\n  workInProgressSources.length = 0;\n}\nexport function getWorkInProgressVersion(mutableSource) {\n  if (isPrimaryRenderer) {\n    return mutableSource._workInProgressVersionPrimary;\n  } else {\n    return mutableSource._workInProgressVersionSecondary;\n  }\n}\nexport function setWorkInProgressVersion(mutableSource, version) {\n  if (isPrimaryRenderer) {\n    mutableSource._workInProgressVersionPrimary = version;\n  } else {\n    mutableSource._workInProgressVersionSecondary = version;\n  }\n\n  workInProgressSources.push(mutableSource);\n}\nexport function warnAboutMultipleRenderersDEV(mutableSource) {\n  if (__DEV__) {\n    if (isPrimaryRenderer) {\n      if (mutableSource._currentPrimaryRenderer == null) {\n        mutableSource._currentPrimaryRenderer = rendererSigil;\n      } else if (mutableSource._currentPrimaryRenderer !== rendererSigil) {\n        console.error('Detected multiple renderers concurrently rendering the ' + 'same mutable source. This is currently unsupported.');\n      }\n    } else {\n      if (mutableSource._currentSecondaryRenderer == null) {\n        mutableSource._currentSecondaryRenderer = rendererSigil;\n      } else if (mutableSource._currentSecondaryRenderer !== rendererSigil) {\n        console.error('Detected multiple renderers concurrently rendering the ' + 'same mutable source. This is currently unsupported.');\n      }\n    }\n  }\n} // Eager reads the version of a mutable source and stores it on the root.\n// This ensures that the version used for server rendering matches the one\n// that is eventually read during hydration.\n// If they don't match there's a potential tear and a full deopt render is required.\n\nexport function registerMutableSourceForHydration(root, mutableSource) {\n  const getVersion = mutableSource._getVersion;\n  const version = getVersion(mutableSource._source); // TODO Clear this data once all pending hydration work is finished.\n  // Retaining it forever may interfere with GC.\n\n  if (root.mutableSourceEagerHydrationData == null) {\n    root.mutableSourceEagerHydrationData = [mutableSource, version];\n  } else {\n    root.mutableSourceEagerHydrationData.push(mutableSource, version);\n  }\n}","map":{"version":3,"sources":["/Users/zhangshuo/git/react-source-test/src/react/packages/react-reconciler/src/ReactMutableSource.new.js"],"names":["isPrimaryRenderer","workInProgressSources","rendererSigil","__DEV__","markSourceAsDirty","mutableSource","push","resetWorkInProgressVersions","i","length","_workInProgressVersionPrimary","_workInProgressVersionSecondary","getWorkInProgressVersion","setWorkInProgressVersion","version","warnAboutMultipleRenderersDEV","_currentPrimaryRenderer","console","error","_currentSecondaryRenderer","registerMutableSourceForHydration","root","getVersion","_getVersion","_source","mutableSourceEagerHydrationData"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA,SAAQA,iBAAR,QAAgC,wBAAhC,C,CAEA;AACA;AACA;;AACA,MAAMC,qBAAgD,GAAG,EAAzD;AAEA,IAAIC,aAAJ;;AACA,IAAIC,OAAJ,EAAa;AACX;AACAD,EAAAA,aAAa,GAAG,EAAhB;AACD;;AAED,OAAO,SAASE,iBAAT,CAA2BC,aAA3B,EAAoE;AACzEJ,EAAAA,qBAAqB,CAACK,IAAtB,CAA2BD,aAA3B;AACD;AAED,OAAO,SAASE,2BAAT,GAA6C;AAClD,OAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGP,qBAAqB,CAACQ,MAA1C,EAAkDD,CAAC,EAAnD,EAAuD;AACrD,UAAMH,aAAa,GAAGJ,qBAAqB,CAACO,CAAD,CAA3C;;AACA,QAAIR,iBAAJ,EAAuB;AACrBK,MAAAA,aAAa,CAACK,6BAAd,GAA8C,IAA9C;AACD,KAFD,MAEO;AACLL,MAAAA,aAAa,CAACM,+BAAd,GAAgD,IAAhD;AACD;AACF;;AACDV,EAAAA,qBAAqB,CAACQ,MAAtB,GAA+B,CAA/B;AACD;AAED,OAAO,SAASG,wBAAT,CACLP,aADK,EAEwB;AAC7B,MAAIL,iBAAJ,EAAuB;AACrB,WAAOK,aAAa,CAACK,6BAArB;AACD,GAFD,MAEO;AACL,WAAOL,aAAa,CAACM,+BAArB;AACD;AACF;AAED,OAAO,SAASE,wBAAT,CACLR,aADK,EAELS,OAFK,EAGC;AACN,MAAId,iBAAJ,EAAuB;AACrBK,IAAAA,aAAa,CAACK,6BAAd,GAA8CI,OAA9C;AACD,GAFD,MAEO;AACLT,IAAAA,aAAa,CAACM,+BAAd,GAAgDG,OAAhD;AACD;;AACDb,EAAAA,qBAAqB,CAACK,IAAtB,CAA2BD,aAA3B;AACD;AAED,OAAO,SAASU,6BAAT,CACLV,aADK,EAEC;AACN,MAAIF,OAAJ,EAAa;AACX,QAAIH,iBAAJ,EAAuB;AACrB,UAAIK,aAAa,CAACW,uBAAd,IAAyC,IAA7C,EAAmD;AACjDX,QAAAA,aAAa,CAACW,uBAAd,GAAwCd,aAAxC;AACD,OAFD,MAEO,IAAIG,aAAa,CAACW,uBAAd,KAA0Cd,aAA9C,EAA6D;AAClEe,QAAAA,OAAO,CAACC,KAAR,CACE,4DACE,qDAFJ;AAID;AACF,KATD,MASO;AACL,UAAIb,aAAa,CAACc,yBAAd,IAA2C,IAA/C,EAAqD;AACnDd,QAAAA,aAAa,CAACc,yBAAd,GAA0CjB,aAA1C;AACD,OAFD,MAEO,IAAIG,aAAa,CAACc,yBAAd,KAA4CjB,aAAhD,EAA+D;AACpEe,QAAAA,OAAO,CAACC,KAAR,CACE,4DACE,qDAFJ;AAID;AACF;AACF;AACF,C,CAED;AACA;AACA;AACA;;AACA,OAAO,SAASE,iCAAT,CACLC,IADK,EAELhB,aAFK,EAGC;AACN,QAAMiB,UAAU,GAAGjB,aAAa,CAACkB,WAAjC;AACA,QAAMT,OAAO,GAAGQ,UAAU,CAACjB,aAAa,CAACmB,OAAf,CAA1B,CAFM,CAIN;AACA;;AACA,MAAIH,IAAI,CAACI,+BAAL,IAAwC,IAA5C,EAAkD;AAChDJ,IAAAA,IAAI,CAACI,+BAAL,GAAuC,CAACpB,aAAD,EAAgBS,OAAhB,CAAvC;AACD,GAFD,MAEO;AACLO,IAAAA,IAAI,CAACI,+BAAL,CAAqCnB,IAArC,CAA0CD,aAA1C,EAAyDS,OAAzD;AACD;AACF","sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {MutableSource, MutableSourceVersion} from 'shared/ReactTypes';\nimport type {FiberRoot} from './ReactInternalTypes';\n\nimport {isPrimaryRenderer} from './ReactFiberHostConfig';\n\n// Work in progress version numbers only apply to a single render,\n// and should be reset before starting a new render.\n// This tracks which mutable sources need to be reset after a render.\nconst workInProgressSources: Array<MutableSource<any>> = [];\n\nlet rendererSigil;\nif (__DEV__) {\n  // Used to detect multiple renderers using the same mutable source.\n  rendererSigil = {};\n}\n\nexport function markSourceAsDirty(mutableSource: MutableSource<any>): void {\n  workInProgressSources.push(mutableSource);\n}\n\nexport function resetWorkInProgressVersions(): void {\n  for (let i = 0; i < workInProgressSources.length; i++) {\n    const mutableSource = workInProgressSources[i];\n    if (isPrimaryRenderer) {\n      mutableSource._workInProgressVersionPrimary = null;\n    } else {\n      mutableSource._workInProgressVersionSecondary = null;\n    }\n  }\n  workInProgressSources.length = 0;\n}\n\nexport function getWorkInProgressVersion(\n  mutableSource: MutableSource<any>,\n): null | MutableSourceVersion {\n  if (isPrimaryRenderer) {\n    return mutableSource._workInProgressVersionPrimary;\n  } else {\n    return mutableSource._workInProgressVersionSecondary;\n  }\n}\n\nexport function setWorkInProgressVersion(\n  mutableSource: MutableSource<any>,\n  version: MutableSourceVersion,\n): void {\n  if (isPrimaryRenderer) {\n    mutableSource._workInProgressVersionPrimary = version;\n  } else {\n    mutableSource._workInProgressVersionSecondary = version;\n  }\n  workInProgressSources.push(mutableSource);\n}\n\nexport function warnAboutMultipleRenderersDEV(\n  mutableSource: MutableSource<any>,\n): void {\n  if (__DEV__) {\n    if (isPrimaryRenderer) {\n      if (mutableSource._currentPrimaryRenderer == null) {\n        mutableSource._currentPrimaryRenderer = rendererSigil;\n      } else if (mutableSource._currentPrimaryRenderer !== rendererSigil) {\n        console.error(\n          'Detected multiple renderers concurrently rendering the ' +\n            'same mutable source. This is currently unsupported.',\n        );\n      }\n    } else {\n      if (mutableSource._currentSecondaryRenderer == null) {\n        mutableSource._currentSecondaryRenderer = rendererSigil;\n      } else if (mutableSource._currentSecondaryRenderer !== rendererSigil) {\n        console.error(\n          'Detected multiple renderers concurrently rendering the ' +\n            'same mutable source. This is currently unsupported.',\n        );\n      }\n    }\n  }\n}\n\n// Eager reads the version of a mutable source and stores it on the root.\n// This ensures that the version used for server rendering matches the one\n// that is eventually read during hydration.\n// If they don't match there's a potential tear and a full deopt render is required.\nexport function registerMutableSourceForHydration(\n  root: FiberRoot,\n  mutableSource: MutableSource<any>,\n): void {\n  const getVersion = mutableSource._getVersion;\n  const version = getVersion(mutableSource._source);\n\n  // TODO Clear this data once all pending hydration work is finished.\n  // Retaining it forever may interfere with GC.\n  if (root.mutableSourceEagerHydrationData == null) {\n    root.mutableSourceEagerHydrationData = [mutableSource, version];\n  } else {\n    root.mutableSourceEagerHydrationData.push(mutableSource, version);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}